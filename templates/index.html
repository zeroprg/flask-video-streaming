<html>
  <head>
    <title>Artificial Intelegence Camera </title>
  </head>
  <body>
      <h1>Artificial Intelegence Camera </h1>
      <img id="image" style="-webkit-user-select: none;"   src="{{ url_for('video_feed') }}">
      <!--h1>Objects founded:</h1-->
      <div id="myDiv"><!-- Plotly chart will be drawn inside this DIV --></div>
      <!-- Optional JavaScript -->
      <!-- jQuery first, then Popper.js, then Bootstrap JS -->
      <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
      <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
      <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
      <script>
          /*var img = document.getElementById('image')
          var source = new EventSource("{{ url_for('video_feed') }}")
          source.addEventListener('image',function (e) {
              img.src = 'data:image/png:base64,' + e.data;
              console.log(img.src)
              });
          */
                        //var r2 = new XMLHttpRequest(); 
              //r2.open('GET', "{{ url_for('video_feed') }}", true);
              //r2.send();
              //r.onreadystatechange

          MAX_BUFFER = 3000
          PLOT_TYPE = 'bar'
          
          window.setInterval(function(){
              ajaxCallFunction();  //calling every 5 second
          }, 1000);
         
          function ajaxCallFunction(){
            //this function uses ajax to interact with the server
            
              var r = new XMLHttpRequest();
             // r.multipart = true;
              r.open('GET', "{{ url_for('params_feed') }}", true);
              r.send();
              r.onprogress = function () {
                  
                 console.log(r.responseText);
                 if(r.responseText != ''){
                     var traces = JSON.parse(r.responseText);
                     //console.log("traces = " + traces);
                     if(traces == null || traces.length == 0) return
                     
                     for( j = 0 ; j< traces.length; j++){
                        var k = 0
                        if( data.length == 0) {data.push(traces[j]); continue}
                        for( i = 0 ; i< data.length; i++){
                           if( traces[j].name == data[i].name ) {
                             data[i].x.push(traces[j].x[0]);
                             data[i].y.push(traces[j].y[0]);
                             data[i].text.push(traces[j].text[0]);
                             data[i].type = PLOT_TYPE
                             if( data[i].x.length >= MAX_BUFFER ) {
                                 data[i].x.shift();
                                 data[i].y.shift();
                                 data[i].text.shift();
                             }  

                           } else {
                               k++
                           }
                        }
                       // check if this a new object not existed before
                       if( k == data.length ){
                             _data = {"x": [],"y": [],"text": []};
                             _data.x.push(traces[j].x[0]);
                             _data.y.push(traces[j].y[0]);
                             _data.text.push(traces[j].text[0]);
                             _data.name = traces[j].name;
                             _data.type = PLOT_TYPE
                           data.push(_data)
                       }    
                     }  
                     Plotly.newPlot('myDiv', data,layout);
                 }
              };
          }
    
          var data = []

          var layout = {
              xaxis: {
                  autorange: true
              },
              yaxis: {
                  autorange: true
              },
              legend: {
                  y: 0.5,
                  yref: 'paper',
                  font: {
                      family: 'Arial, sans-serif',
                      size: 20,
                      color: 'grey',
                  }
              },
              title: 'Founded objects per time (1 sec beet)'
          };

 
      </script>

  </body>


</html>
