<html>
<head>
  <title>Artificial Intellegence Cameras</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <link rel="stylesheet" href="static/css/main.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script> 
</head>
<body>

<div class="container">
  <h1>Artificial Intellegence Cameras </h1>
  <p>This example demonstrates AI image recognizing  web server works with any IP Cameras feed.More details on <a href="http://aicameras.ca">http://aicameras.ca</a></p>         
  <p>Time for all cameras feeds in GMT (Greenwich Mean Time)</p>
  {% for cam,video_url in video_urls %}
  <div class="row">
    <div class="col-sm-6">
      <h5>camera URL: {{video_url}}:</h5>
      <img style="-webkit-user-select: none; width:100%" src="{{video_url}}">
    </div>
    <div class="col-sm-6">      
         <div class="tab">
            <button class="tablinks" onclick="openTab(event, 'Eventsnotifyer{{cam}}')">Events notifyer</button>
            <button class="tablinks" onclick="openTab(event, 'Objectsfilter{{cam}}')">Founded Objects</button>
         </div>
          <div id="Eventsnotifyer{{cam}}" class="tabcontent" style="display: block;">
            <h3>Events notifyer</h3>
            <p>Specify Events which will triger eMail or SMS/Voice notify.</p>
              if <select name="objects">
                <option value="person">person</option>
                <option value="car">car</option>
                <option value="dog">dog</option>
                <option value="cat">cat</option>
              </select> and 
              <select name="quantity">
                <option value="quantity">quantity</option>
                <option value="time">time(sec.)</option>
              </select> 
              <select name="&gt;>">
                <option value="&gt;">&gt;</option>
                <option value="&lt;">&lt;</option>
                <option value="=">=</option>
              </select>              
              <input type="number" id="quantity" name="quantity" placeholder="0" min="0" max="100" />
              <br>
              Notify me by 
              <select name="eMail;>">
                <option value="email;">email</option>
                <option value="sms">SMS</option>
                <option value="voice">voice</option>
              </select> 
              :
              <input type="text" placeholder="" min="0" max="100" />
          </div>

          <div id="Objectsfilter{{cam}}" class="tabcontent" >
            <!-- Header -->
            <div class="header" id="myHeader">
              <button class="btn"  onclick="showmore(1,{{cam}});styleit();"><<</button>
              <button class="btn"  onclick="start=0;showmore(1,{{cam}}); styleit()">.</button>
              <button class="btn"  onclick="showmore(-1,{{cam}};styleit();)">>></button>
            </div>          
          <!-- Photo Grid -->
          <div id="cam{{cam}}" class="images_row">
           {% set i = 0 %} 
           {% for result in images_filenames %}
             {% if result.startswith(img_folder + cam + "_") %}
                {% if i%3 == 0 %}
                   <div class="column">
                {% endif %}   
                <a class="thumb" target="_blank" href="{{result}}">
                  <img src="{{result}}" style="width:100%" alt="">
                </a>
                {% if i%3 == 0 %}
                   </div>
                {% endif %}   
                {% set i= i + 1%}
              {% endif %}
           {% endfor %}
            </div> 
          </div>
    </div>
    <div id= "myDiv{{cam}}" class="col-sm-12" style="height:250px; width:100%"></div>
 </div>
 {% endfor %}
</div>


<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

<script>

function openTab(evt, tabName) {
    var i, tabcontent, tablinks;
    tabcontent = document.getElementsByClassName("tabcontent");
    for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
    }
    tablinks = document.getElementsByClassName("tablinks");
    for (i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
    }
    document.getElementById(tabName).style.display = "block";
    evt.currentTarget.className += " active";
}

// Get the elements with class="column"
var elements = document.getElementsByClassName("column");

// Declare a loop variable
var i;


// Four images side by side
function styleit() {
    for (i = 0; i < elements.length; i++) {
        elements[i].style.msFlex = "25%";  // IE10
        elements[i].style.flex = "25%";
    }
}

// Add active class to the current button (highlight it)
var header = document.getElementById("myHeader");
var btns = header.getElementsByClassName("btn");
for (var i = 0; i < btns.length; i++) {
  btns[i].addEventListener("click", function() {
    var current = document.getElementsByClassName("active");
    current[0].className = current[0].className.replace(" active", "");
    this.className += " active";
  });
}


var start = 0
function showmore(direction, cam)
{
  //  var cam = $(this).attr("data-cam"); 

    if (start + direction*{{img_paginator}} < 0) direction = -direction
  
    $.ajax({
      url: "/moreimgs?start=" + start + "&cam=" + cam + "&direction="+direction,
      type: "get",      
      success: function(response) {
       // parse array of images filenames
       console.log(response)
       start = start + direction*{{img_paginator}}
       filenames = JSON.parse(response)
       a =  '<div>';
       for (i = 0; i < filenames.length; i++) {
          //_filename = filenames[i].split("_");
          //last_one = _filename[_filename.length -1 ];
          //before_last_one = _filename[_filename.length - 2 ];
          
          //_date =  new Date(parseFloat(before_last_one +'.'+last_one.substring(0, last_one.length -4))).toISOString();
/*            a +='<a class="thumb" target="_blank" href="' + filenames[i]+ '">' +
                  '<img src="'+filenames[i]+ '" style="width:35px;max-height: 70px;">' +
                  '<span><img src="' + filenames[i]+ '" style="width:250px;"></span>'+
                '</a>'
 */               
              if( i%3 == 0 ) a += '</div><div class="column">'
                
                a+= '<a class="thumb" target="_blank" href="' + filenames[i]+ '">' +
                        '<img src="' + filenames[i]+ '" style="width:100%;" alt="">' +
                    '</a>'
            
                
        }
        a += '</div>'
        $('#cam' + cam ).html(a);
      },
      error: function(xhr) {
        //Do Something to handle error
      }
    });

};

          MAX_BUFFER = 10000
          BEAT = 1
          PLOT_TYPE = 'bar'
          
          window.setInterval(function(){
              ajaxCallFunction();  //calling every 5 second
          }, BEAT*1000);
         
          function ajaxCallFunction(){
            //this function uses ajax to interact with the server
            
              var r = new XMLHttpRequest();
             // r.multipart = true;
              r.open('GET', "{{ url_for('params_feed') }}", true);
              r.send();
              r.onprogress = function () {
                  
                 //console.log(r.responseText);
                 if(r.responseText != ''){
                     var traces = JSON.parse(r.responseText);
                     //console.log("traces = " + traces);
                     if(traces == null || traces.length == 0) return
                     
                     for( j = 0 ; j< traces.length; j++){
                        var k = 0
                        tr = traces[j]
                        cam = tr.cam
                        /*if( data == undefined) {
                          data = [[]];
                          tr = traces[j]
                          data[tr.cam].push(tr);
                          continue;
                          } 
                        */  
                        for( i = 0 ; i< data[cam].length; i++){
                           if( tr.name == data[cam][i].name ) {
                             data[cam][i].x.push(tr.x);
                             data[cam][i].y.push(tr.y);
                             data[cam][i].text.push(tr.text + ' cam:' + cam);
                             data[cam][i].type = PLOT_TYPE
                             if( data[cam][i].x.length >= MAX_BUFFER ) {
                                 data[cam][i].x.shift();
                                 data[cam][i].y.shift();
                                 data[cam][i].text.shift();
                             }  

                           } else {
                               k++
                           }
                        }
                       // check if this a new object not existed before
                        if( k == data[cam].length ){
                             _data = {"x": [],"y": [],"text": []};
                             _data.x.push(traces[j].x);
                             _data.y.push(traces[j].y);
                             _data.text.push(traces[j].text + ' cam:' + traces[j].cam);
                             _data.name = traces[j].name;
                             _data.type = PLOT_TYPE
                           data[cam].push(_data)
                         }    
                     }  
                     Plotly.newPlot('myDiv'+cam, data[cam],layout);
                 }
              };
          }
    
          var data = [[],[]];
          var layout = {
              xaxis: {
                  autorange: true
              },
              yaxis: {
                  autorange: true
              },
              legend: {
                  y: 0.5,
                  yref: 'paper',
                  font: {
                      family: 'Arial, sans-serif',
                      size: 20,
                      color: 'grey',
                  }
              },
              title: 'Founded objects per time (6 sec beet)'
          };

</script>


 </body>
</html>
